## 変数、定数

[Ruby技術者認定試験の書籍写経メモ]({% post_url 2017-07-22-ruby技術者認定試験の書籍写経メモ %})

### 組み込み定数

| ARGV | 起動時の引数 argument vector |
| ENV  | 環境変数                     |

### 環境変数

RUBYOPT [コマンドライン起動時のオプション]({% post_url 2017-07-22-使用頻度が少なくあまり意識していない要素メモ %}#コマンドライン起動時のオプション) を指定しておける

```sh
# 現在の値を確認
$ echo $RUBYOPT

# cはダメっぽい　そりゃそうだ

$ export RUBYOPT=-c
$ ruby temp1.rb
ruby: invalid switch in RUBYOPT: -c (RuntimeError)
```

RUBYLIB ライブラリ検索パス

```sh
# 現在の値を確認
$ echo $RUBYLIB

$ export RUBYLIB=/the/path/you/
$ ruby temp1.rb
```

### 特殊変数

頭が$

| $:       | $LOAD_PATH                             |
| $*       | ARGV                                   |
| $_       | 最後にgetsかreadlineで読み込んだ文字列 |
| $~[n]    | 最後に成功したマッチに対する結果       |
| $`       | マッチした部分より前の文字列           |
| $&       | マッチした部分                         |
| $'       | マッチした部分より後の文字列           |
| $+       | マッチした最後のキャプチャ             |
| $1, $2.. | マッチしたn番目のキャプチャ            |
| $?       | 最後に終了した子プロセス               |
| $!       | 直近で補足した例外オブジェクト         |
| $@       | バックトレース                         |
| $0       | 実行中のプログラムファイル名           |

### ローカル変数

- /\A[a-z][a-zA-Z0-9_]*\z/
- 代入が行われた位置から、その代入を含む(ブロック定義, メソッド定義、クラス定義)の終わりまでがスコープ
- つまりメソッド外で定義されたローカル変数はメソッド内から参照できない。定義内は独立したスコープを持ち、相互に参照できない
- 参照箇所より前に代入文が記述してある時には実行の有無にかかわらずnil、記述してない場合は例外発生

### グローバル変数

- /\A\$[a-zA-Z0-9_]*\z/
- どこからでも参照可能！
- 初回の参照からいきなりnil
- ぶっちゃけ使わない　使うな

### インスタンス変数

- /\A@@[a-zA-Z0-9_]*\z/
- そのインスタンス内で値を保持する
- メソッドのように探索されない。そのインスタンス内で完結し生成元クラスも継承チェーンも関係ない
- 初期化されていなくてもnilを返す

### クラス変数

- /\A@@[a-zA-Z0-9_]*\z/
- そのクラスのインスタンス、サブクラス、サブクラスのインスタンスから参照できる
- 初期化していないのに参照すると例外発生

```ruby
class Moko1
  @@v1 = 1

  def v1
    @@v1
  end

  def v1=(value)
    @@v1 = value
  end
end

class Moko2 < Moko1
end

moko1 = Moko1.new

moko1.v1
=> 1

moko2 = Moko2.new

moko2.v1
=> 1

moko2.v1 = 100

moko1.v1 = 100
=> 100
```

- 継承するクラスで同盟のクラス変数を定義してしまったら、スーパークラスのクラス変数を書き換える、と言うこと
- サブクラスとスーパークラスで別々の値が保持されると判断しがちなので注意

```ruby
class Moko1
  @@v1 = 1

  def v1
    @@v1
  end
end

class Moko2 < Moko1
  @@v1 = 2
end

moko1 = Moko1.new

moko1.v1
=> 2

moko2 = Moko2.new

moko2.v1
=> 2
```

### 定数

- /\A[A-Z][a-zA-Z0-9_]*\z/
- 定義された(クラス, モジュール)内から参照可能
- その内部で定義された(クラス, モジュール)内から参照可能
- その(クラス, モジュール)を継承、インクルードしたモジュール内から参照可能
- (クラス, モジュール)名で修飾すれば外部からも参照可能
- 初期化していないのに参照すると例外発生
- 再定義しようとすると警告は出るがエラーにはならない
- モジュールやクラスの継承チェーンを駆け上がり探索される

再定義時の警告

```ruby
 A = 1
=> 1

A = 2
warning: already initialized constant A
warning: previous definition of A was here
=> 2
```

メソッドは複数回実行が前提なので定数の初期化、更新は許されていない

```ruby
def moko
  A = 3
end
#=> SyntaxError: (irb): dynamic constant assignment
```

### 重要なので何度でも言うぞ

- Rubyインタプリタは初出の変数への代入式を検出し
- たとえその行が実行されなくとも
- 代入式より右に記述してある内容の解釈よりも先に変数をnilにて用意する

```ruby
moko
NameError: undefined local variable or method 'moko'

if false
  moko = 1
end

moko
#=> nil
```

```ruby
> hage
NameError: undefined local variable or method 'hage'

> hage.to_s
NameError: undefined local variable or method 'hage'

> hage = hage.to_s
#=> ""
```

### 疑似変数

- 厳密にはtrueやfalseはリテラルではない
- 疑似変数には代入できない

| true          | TrueClassクラスの唯一のインスタンス                           |
| false         | FalseClassクラスの唯一のインスタンス                          |
| nil           | NilClassクラスの唯一のインスタンス                            |
| self          | 現在のオブジェクト                                            |
| \__FILE__     | 現在実行しているプログラムファイル名 $0とは微妙に違ったりする |
| \__LINE__     | 現在実行しているプログラムの行番号                            |
| \__ENCODING__ | 現在のソースファイルのエンコーディング                        |
