## Rubyのメタプログラミングの書籍写経メモ

某書を写経したメモ

### 少女M

#### メタプログラミングとは

- コードを記述するコードを記述することである
- 言語要素を実行時に操作するコードを記述することである

### オブジェクトモデル

- インスタンスにはインスタンス変数とクラスへの参照があるのみ、メソッドはクラスに存在する
- クラスにはクラスインスタンス変数とスーパークラスへの参照がある、クラスメソッドは特異クラスに存在する
- オブジェクトのメソッドはそのクラスのインスタンスメソッドであるように、
- クラスのメソッドはClassクラスのインスタンスメソッドである
- ネームスペース
  - 定数
    - ```ruby
      module A
        module B
          C = 'A_B_C'
        end

        p B::C
        # => "A_B_C"
      end

      p A::B::C
      # => "A_B_C"
      ```
    - ```ruby
      B = 'B'
      module A
        B = 'A_B'

        p B
        # => "A_B"

        p ::B
        # => "B"
      end
      ```
    - ```ruby
      # レシーバ内部の定数一覧
      A::B.constants
      # => [:C]
      
      # トップレベルの定数一覧
      Module.constants
      # => [.....]
      ```
    - ```ruby
      # パスの取得もできる 
      module A
        class B
          module C
            p Module.nesting
            # => [A::B::C, A::B, A]
          end
        end
      end
      ```
    - load は定数が既存の定数を汚染する可能性がある　そういう場合には load(path, true) を使うと無名モジュールでラッピングし解釈、その後破棄してくれる
    - require は定数等を取り込むためのものである為、そういう心配も機能も無い
  - メソッド探索
    - メソット呼び出し
      - メソッド探索を行う
        - 継承チェーン
          - Rubyがクラスに入り、メソッドを見つけるまで継承チェーンを登る
          - object.singleton_class.ancestors
          - include module
          - prepend module
          - 継承チェーンに既に存在しているモジュールはインクルードされない。無視される
          - ```ruby
            module M1
            end

            p M1.ancestors
            #=> [M1]

            module M2
              include M1
            end

            p M1.ancestors
            #=> [M1]

            p M2.ancestors
            #=> [M2, M1]

            module M3
              prepend M1
              include M2
            end

            p M1.ancestors
            #=> [M1]

            p M2.ancestors
            #=> [M2, M1]

            p M3.ancestors
            #=> [M1, M3, M2] # include M2 しようとした時に「あ、M1はもう居るじゃん、君は無しね」となる
            # まぁ、[M1, M3, M2, M1]で前方優先でユニークにした、と考えてもいいのかもしれない
            ```
      - self が必要
        - レシーバ
